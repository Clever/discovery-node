# discovery-node

This library programmatically finds endpoints for dependencies. Similar to [discovery-go](https://github.com/Clever/discovery-go) and [discovery-python](https://github.com/Clever/discovery-python).

See [Service Discovery](https://github.com/Clever/infra-docs/blob/master/deploy/service_discovery.md) for more details.

## API

- disc = **discovery**(\<service\>, \<interface\>)
  - disc.**proto**() - returns the service protocol
  - disc.**host**() - returns the hostname or ip
  - disc.**port**() - returns the port
  - disc.**host_port**() - returns (\<host\>:\<port\>)
  - disc.**proto_host**() - returns (\<proto\>://\<host\>)
  - disc.**url**() - returns the url (\<proto\>://\<host\>:\<port\>)

### install and import

```bash
npm install --save clever-discovery
```

```coffee
discovery = require "clever-discovery"
```

### examples

```coffee
disc_gearman = discovery("gearman-admin", "http")
try gearman_url = disc_gearman.url() catch err then cb(err)

disc_stoked = discovery("stoked", "thrift")
try stoked_host = disc_stoked.host() catch err then cb(err)
try stoked_port = disc_stoked.port() catch err then cb(err)
```

## Implementation Details

Currently, `discovery-{go,node,python}` looks for environment variables with the following format:

```
SERVICE_{SERVICE_NAME}_{EXPOSE_NAME}_{PROTO,HOST,PORT}
```

These environment variables are autogenerated by [fab](http://github.com/Clever/fabulaws) and [catapult](http://github.com/Clever/catapult) during app deployment.  Three env-vars are created for each app listed in the `dependencies` section of caller's launch yaml.

For example, if an app lists `district-authorizations` as a dependency, fab and catapult will generate this env-vars triplet:

```bash
SERVICE_DISTRICT_AUTHORIZATIONS_HTTP_PROTO = "http"
SERVICE_DISTRICT_AUTHORIZATIONS_HTTP_HOST = "district-authorizations.ops.clever.com"
SERVICE_DISTRICT_AUTHORIZATIONS_HTTP_PORT = "80"
```
